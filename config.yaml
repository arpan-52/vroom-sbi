# =============================================================================
# VROOM-SBI Configuration File
# =============================================================================

# Frequency file path (required)
freq_file: "freq.txt"

# =============================================================================
# PRIOR RANGES
# =============================================================================
# All parameter bounds for all model types are defined here.
# Parameters by model type:
#   - faraday_thin:        [RM, amp, chi0] per component
#   - burn_slab:           [phi_c, delta_phi, amp, chi0] per component
#   - external_dispersion: [phi, sigma_phi, amp, chi0] per component
#   - internal_dispersion: [phi, sigma_phi, amp, chi0] per component

priors:
  # Rotation Measure / Faraday depth (rad/m²)
  # Used for RM in faraday_thin, phi/phi_c in other models
  rm:
    min: -500.0
    max: 500.0
  
  # Fractional polarization amplitude (dimensionless, 0-1)
  amp:
    min: 0.01
    max: 1.0
  
  # Intrinsic polarization angle (radians)
  # Physical constraint: [0, π]
  chi0:
    min: 0.0
    max: 3.14159265  # π
  
  # RM dispersion for external/internal dispersion models (rad/m²)
  sigma_phi:
    min: 0.0
    max: 200.0
  
  # Slab half-width for burn_slab model (rad/m²)
  # Full slab width = 2 × delta_phi
  delta_phi:
    min: 0.0
    max: 200.0

# =============================================================================
# NOISE CONFIGURATION
# =============================================================================
# Noise as percentage of signal amplitude
# sigma = noise_percent/100 * |P| at each channel

noise:
  base_percent: 10.0      # 10% noise relative to signal amplitude
  augmentation:
    enable: true
    min_factor: 0.5       # Minimum: 5% noise (0.5 × 10%)
    max_factor: 2.0       # Maximum: 20% noise (2.0 × 10%)

# =============================================================================
# TRAINING SETTINGS
# =============================================================================

training:
  # Simulation generation
  n_simulations: 30000              # Base simulations (for N=1)
  simulation_scaling: true          # Scale up for more components
  simulation_scaling_mode: "power"  # Options: linear, quadratic, subquadratic, power
  scaling_power: 2.5                # Exponent for power mode (N^2.5)
  
  # Chunked streaming (for large datasets)
  simulation_batch_size: 30000      # Samples per chunk file (tune for RAM)
  
  # Neural network training
  training_batch_size: 1024         # Mini-batch size for GPU
  learning_rate: 0.0005             # Adam learning rate
  validation_fraction: 0.1          # Fraction for validation
  stop_after_epochs: 20             # Early stopping patience
  
  # Hardware
  device: "cuda"                    # cuda or cpu
  
  # Output
  save_dir: "models"

# =============================================================================
# MODEL SELECTION
# =============================================================================

model_selection:
  min_components: 1       # Minimum components to train
  max_components: 5       # Maximum components to train
  use_classifier: false   # Train classifier for model selection
  classifier_only: false  # Skip posterior training (requires existing simulations)

# =============================================================================
# PHYSICAL MODELS
# =============================================================================

physics:
  # List of model types to train
  # Options: faraday_thin, burn_slab, external_dispersion, internal_dispersion
  model_types:
    - "faraday_thin"
    # - "burn_slab"
    # - "external_dispersion"
    # - "internal_dispersion"

# =============================================================================
# WEIGHT AUGMENTATION
# =============================================================================
# Simulates realistic data with missing channels, RFI gaps, etc.

weight_augmentation:
  enable: true
  scattered_prob: 0.3     # Probability of scattered missing channels
  gap_prob: 0.3           # Probability of contiguous gaps
  large_block_prob: 0.1   # Probability of large RFI blocks
  noise_variation: true   # Add noise variation to weights

# =============================================================================
# CLASSIFIER (Model Selection)
# =============================================================================
# 1D CNN that predicts number of components from spectra

classifier:
  conv_channels: [32, 64, 128]
  kernel_sizes: [7, 5, 3]
  dropout: 0.1
  n_epochs: 50
  batch_size: 1024
  learning_rate: 0.0001
  validation_fraction: 0.2
  use_posterior_simulations: true

# =============================================================================
# SBI ARCHITECTURE (Neural Spline Flow)
# =============================================================================

sbi:
  model: "nsf"            # nsf (Neural Spline Flow) or maf
  num_bins: 16            # Spline resolution
  embedding_dim: 64       # Spectral embedding output dimension
  
  # Architecture per component count
  # Same architecture for all N to isolate effect of simulation scaling
  architecture_scaling:
    1:
      hidden_features: 256
      num_transforms: 15
    2:
      hidden_features: 256
      num_transforms: 15
    3:
      hidden_features: 256
      num_transforms: 15
    4:
      hidden_features: 256
      num_transforms: 15
    5:
      hidden_features: 256
      num_transforms: 15
